# K10-CLEANER License Compliance Monitor — Nginx config
#
# Setup:
#   1. Copy to /etc/nginx/sites-available/k10-monitor
#   2. ln -s /etc/nginx/sites-available/k10-monitor /etc/nginx/sites-enabled/
#   3. sudo certbot --nginx -d k10-monitor.togioma.gr
#   4. sudo nginx -t && sudo systemctl reload nginx
#
# The receiver.py backend must be running on 127.0.0.1:8080

server {
    listen 80;
    server_name k10-monitor.togioma.gr;

    # Redirect HTTP -> HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name k10-monitor.togioma.gr;

    # SSL — certbot will fill these in automatically
    # ssl_certificate     /etc/letsencrypt/live/k10-monitor.togioma.gr/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/k10-monitor.togioma.gr/privkey.pem;

    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;

    # Only accept POST to the telemetry endpoint and GET to health
    location /api/v1/telemetry {
        # Pass the real client IP to the backend
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;

        # Only allow POST
        limit_except POST {
            deny all;
        }

        # Limit body size (telemetry payloads are small)
        client_max_body_size 64k;

        # Proxy to the Python receiver
        proxy_pass http://127.0.0.1:8080;
        proxy_read_timeout 10s;
    }

    location /health {
        proxy_pass http://127.0.0.1:8080;
        proxy_read_timeout 5s;
    }

    # Block everything else
    location / {
        return 404;
    }

    # Access log for audit
    access_log /var/log/nginx/k10-monitor-access.log;
    error_log  /var/log/nginx/k10-monitor-error.log;
}
